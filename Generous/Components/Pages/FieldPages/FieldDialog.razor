@using Generous.Models
@using Microsoft.EntityFrameworkCore;
@implements IDialogContentComponent<Field>
@rendermode InteractiveServer

<FluentStack Orientation="Orientation.Vertical" VerticalGap="15" Style="width: 100%;">
    
    <FluentTextField @bind-Value="@NameValue"
                     Style="width: 100%;">
        Field Name:
    </FluentTextField>

    <FluentTextArea @bind-Value="@Content.Description"
                    Rows="5"
                    Style="width: 100%;">
        Field Description:
    </FluentTextArea>

    <FluentSelect TOption="FieldType"
                  Label="Select Field Type"
                  Items="@FieldTypesList"
                  Id="element-listbox"
                  Width="100%"
                  OptionText="@(ft => ft.Name)"
                  @bind-SelectedOption="@SelectedFieldType" />


</FluentStack>

@code {
    [Parameter]
    public Field Content { get; set; } = default!;

    [CascadingParameter]
    public FluentDialog? Dialog { get; set; }

    [Inject] public IDbContextFactory<AppDbContext> DbFactory { get; set; } = default!;

    private FieldType? SelectedFieldType
    {
        get => Content.FieldType;
        set
        {
            Content.FieldType = value;
            if (value != null)
            {
                Content.FieldTypeId = value.Id; // Sync the Foreign Key!
            }

            // Trigger validation logic if needed
            ToggleDialogPrimaryActionButton(!string.IsNullOrWhiteSpace(Content.Name) && value != null);
        }
    }
    private List<FieldType> FieldTypesList { get; set; }

    private string? NameValue
    {
        get => Content.Name;
        set
        {
            if (Content.Name != value)
            {
                Content.Name = value;
                // This fires every time the user types!
                ToggleDialogPrimaryActionButton(!string.IsNullOrWhiteSpace(value));
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        ToggleDialogPrimaryActionButton(!string.IsNullOrWhiteSpace(Content.Name));
        await LoadFieldTypesAsync();
    }

    private void ToggleDialogPrimaryActionButton(bool enable)
    {
        Dialog!.TogglePrimaryActionButton(enable);
    }

    private async Task LoadFieldTypesAsync()
    {
        using var _context = DbFactory.CreateDbContext();
        FieldTypesList = await _context.FieldTypes.ToListAsync();
        SelectedFieldType = await _context.FieldTypes.FirstOrDefaultAsync();
    }
}
